# Terraform module: Codreum DNS Monitoring (Free)

This module detects DNS misconfiguration by alerting on **NXDOMAIN spikes** using **CloudWatch Logs, Metrics, Dashboards, Alarms, and Contributor Insights**.

It assumes DNS query logs are **already flowing into CloudWatch Logs** (it does not create log groups or ship logs anywhere).

## What it creates

- CloudWatch dashboards for DNS operations visibility
- CloudWatch alarms (including anomaly options, if enabled by variables)
- Custom metrics derived from log patterns
- Contributor Insights “Top-N” rules for triage (e.g., top NXDOMAIN names / sources)

## Prerequisites

1. Route 53 DNS query logs are enabled and delivered to CloudWatch Logs:
   - Hosted zone query logs (CLF-like)
   - Resolver query logs (JSON)
2. You have an SNS topic ARN for alarm notifications (or will create one)

## Modes (Zone vs VPC)

This module can operate in either (or both) modes:

- **Zone mode**: enabled when `free_zone_id` is set (non-null)
- **VPC mode**: enabled when `free_vpc_id` is set (non-null)

## Quickstart

Your canonical Quickstart is in the **repo root** `README.md`.

Minimal example (reference only):

```hcl
module "codreum_dns_free" {
  # If publishing to a registry, replace with the registry source.
  source = "github.com/Codreum/terraform-aws-dns-monitoring-free//modules?ref=v0.1.0"

  prefix                = "acme-dev"
  aws_region             = "us-east-1"
  tags                   = { env = "dev" }

  free_log_group_name    = "/aws/route53/resolver-query-logs"
  dns_alert_sns_arn      = "arn:aws:sns:us-east-1:123456789012:alerts"

  # Enable either or both:
  free_vpc_id            = "vpc-0123456789abcdef0"  # optional (VPC mode)
  free_zone_id           = null                     # optional (Zone mode)
}
```

## Documentation (auto-generated)

The Inputs/Outputs below are **auto-generated by terraform-docs** and kept in sync via **pre-commit** and **CI**.

- Manual regen from repo root:
  ```bash
  terraform-docs markdown table --output-file modules/README.md --output-mode inject ./modules
  ```

> Do not edit the auto-generated section by hand. Update `variable.tf` / `output.tf` instead.

<!-- BEGIN_TF_DOCS -->
## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | >= 1.14.0 |
| <a name="requirement_aws"></a> [aws](#requirement\_aws) | >= 6.2.0 |

## Providers

| Name | Version |
|------|---------|
| <a name="provider_aws"></a> [aws](#provider\_aws) | >= 6.2.0 |

## Modules

No modules.

## Resources

| Name | Type |
|------|------|
| [aws_cloudwatch_contributor_insight_rule.vpc_topn_nxdomain_qname](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_contributor_insight_rule) | resource |
| [aws_cloudwatch_contributor_insight_rule.vpc_topn_nxdomain_srcip](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_contributor_insight_rule) | resource |
| [aws_cloudwatch_contributor_insight_rule.zone_topn_nxdomain_edge](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_contributor_insight_rule) | resource |
| [aws_cloudwatch_contributor_insight_rule.zone_topn_nxdomain_qname](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_contributor_insight_rule) | resource |
| [aws_cloudwatch_contributor_insight_rule.zone_topn_nxdomain_qtype](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_contributor_insight_rule) | resource |
| [aws_cloudwatch_contributor_insight_rule.zone_topn_nxdomain_rip](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_contributor_insight_rule) | resource |
| [aws_cloudwatch_dashboard.ops_dns_landing](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_dashboard) | resource |
| [aws_cloudwatch_dashboard.vpc_dns_dashboard](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_dashboard) | resource |
| [aws_cloudwatch_dashboard.zone_dns_dashboard](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_dashboard) | resource |
| [aws_cloudwatch_log_metric_filter.vpc_nxdomain_count](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_log_metric_filter) | resource |
| [aws_cloudwatch_log_metric_filter.vpc_total_count](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_log_metric_filter) | resource |
| [aws_cloudwatch_log_metric_filter.zone_nxdomain_count](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_log_metric_filter) | resource |
| [aws_cloudwatch_log_metric_filter.zone_total_count](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_log_metric_filter) | resource |
| [aws_cloudwatch_metric_alarm.vpc_nxdomain_alarm](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_metric_alarm) | resource |
| [aws_cloudwatch_metric_alarm.vpc_nxdomain_anomaly](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_metric_alarm) | resource |
| [aws_cloudwatch_metric_alarm.vpc_nxdomain_rate_alarm](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_metric_alarm) | resource |
| [aws_cloudwatch_metric_alarm.vpc_nxdomain_rate_anomaly](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_metric_alarm) | resource |
| [aws_cloudwatch_metric_alarm.zone_nxdomain_alarm](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_metric_alarm) | resource |
| [aws_cloudwatch_metric_alarm.zone_nxdomain_anomaly](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_metric_alarm) | resource |
| [aws_cloudwatch_metric_alarm.zone_nxdomain_rate_alarm](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_metric_alarm) | resource |
| [aws_cloudwatch_metric_alarm.zone_nxdomain_rate_anomaly](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_metric_alarm) | resource |
| [aws_caller_identity.current](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/caller_identity) | data source |
| [aws_partition.current](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/partition) | data source |
| [aws_route53_zone.free_zone](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/route53_zone) | data source |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_aws_region"></a> [aws\_region](#input\_aws\_region) | n/a | `string` | n/a | yes |
| <a name="input_dns_alert_sns_arn"></a> [dns\_alert\_sns\_arn](#input\_dns\_alert\_sns\_arn) | SNS ARN for alarms. | `string` | n/a | yes |
| <a name="input_free_log_group_name"></a> [free\_log\_group\_name](#input\_free\_log\_group\_name) | CloudWatch Logs group for Route 53 Resolver query logs. | `string` | n/a | yes |
| <a name="input_free_vpc_anomaly_band_width"></a> [free\_vpc\_anomaly\_band\_width](#input\_free\_vpc\_anomaly\_band\_width) | Std-dev width for anomaly band on VPC metrics. | `number` | `null` | no |
| <a name="input_free_vpc_anomaly_eval_periods"></a> [free\_vpc\_anomaly\_eval\_periods](#input\_free\_vpc\_anomaly\_eval\_periods) | Evaluation periods for VPC anomaly alarms. | `number` | `null` | no |
| <a name="input_free_vpc_id"></a> [free\_vpc\_id](#input\_free\_vpc\_id) | Optional VPC to scope NXDOMAIN client insights & alarm. | `string` | `null` | no |
| <a name="input_free_vpc_nxdomain_alarm_period"></a> [free\_vpc\_nxdomain\_alarm\_period](#input\_free\_vpc\_nxdomain\_alarm\_period) | n/a | `number` | `null` | no |
| <a name="input_free_vpc_nxdomain_eval_periods"></a> [free\_vpc\_nxdomain\_eval\_periods](#input\_free\_vpc\_nxdomain\_eval\_periods) | n/a | `number` | `null` | no |
| <a name="input_free_vpc_nxdomain_rate_threshold_pct"></a> [free\_vpc\_nxdomain\_rate\_threshold\_pct](#input\_free\_vpc\_nxdomain\_rate\_threshold\_pct) | n/a | `number` | `null` | no |
| <a name="input_free_vpc_nxdomain_threshold"></a> [free\_vpc\_nxdomain\_threshold](#input\_free\_vpc\_nxdomain\_threshold) | n/a | `number` | `null` | no |
| <a name="input_free_vpc_topn_nxdomain"></a> [free\_vpc\_topn\_nxdomain](#input\_free\_vpc\_topn\_nxdomain) | n/a | `number` | `null` | no |
| <a name="input_free_zone_anomaly_band_width"></a> [free\_zone\_anomaly\_band\_width](#input\_free\_zone\_anomaly\_band\_width) | Std-dev width for anomaly band on Zone metrics (e.g., 2.0 ≈ ~95%). | `number` | `null` | no |
| <a name="input_free_zone_anomaly_eval_periods"></a> [free\_zone\_anomaly\_eval\_periods](#input\_free\_zone\_anomaly\_eval\_periods) | Evaluation periods for Zone anomaly alarms. | `number` | `null` | no |
| <a name="input_free_zone_id"></a> [free\_zone\_id](#input\_free\_zone\_id) | Optional hosted zone (Zxxxxxxxx) to scope 'top NXDOMAIN names'. | `string` | `null` | no |
| <a name="input_free_zone_nxdomain_alarm_period"></a> [free\_zone\_nxdomain\_alarm\_period](#input\_free\_zone\_nxdomain\_alarm\_period) | n/a | `number` | `null` | no |
| <a name="input_free_zone_nxdomain_eval_periods"></a> [free\_zone\_nxdomain\_eval\_periods](#input\_free\_zone\_nxdomain\_eval\_periods) | n/a | `number` | `null` | no |
| <a name="input_free_zone_nxdomain_rate_threshold_pct"></a> [free\_zone\_nxdomain\_rate\_threshold\_pct](#input\_free\_zone\_nxdomain\_rate\_threshold\_pct) | n/a | `number` | `null` | no |
| <a name="input_free_zone_nxdomain_threshold"></a> [free\_zone\_nxdomain\_threshold](#input\_free\_zone\_nxdomain\_threshold) | n/a | `number` | `null` | no |
| <a name="input_free_zone_topn_nxdomain"></a> [free\_zone\_topn\_nxdomain](#input\_free\_zone\_topn\_nxdomain) | n/a | `number` | `null` | no |
| <a name="input_prefix"></a> [prefix](#input\_prefix) | n/a | `string` | n/a | yes |
| <a name="input_tags"></a> [tags](#input\_tags) | n/a | `map(string)` | n/a | yes |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_alarms"></a> [alarms](#output\_alarms) | Alarm names and ARNs for integrating with other systems. |
| <a name="output_contributor_insights_rules"></a> [contributor\_insights\_rules](#output\_contributor\_insights\_rules) | Contributor Insights rule names (Top-N) created by this module. |
| <a name="output_dashboards"></a> [dashboards](#output\_dashboards) | CloudWatch dashboard names and console URLs. |
| <a name="output_enabled"></a> [enabled](#output\_enabled) | Which modes are enabled in this deployment. |
| <a name="output_metrics"></a> [metrics](#output\_metrics) | Custom metric namespace and metric names created by this module. |
<!-- END_TF_DOCS -->
