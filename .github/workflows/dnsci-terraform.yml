name: CI - Terraform

on:
  push:
    branches: [main]
  pull_request:

permissions:
  contents: read
  id-token: write

jobs:
  terraform-fmt:
    name: terraform fmt (repo)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd
        with:
          terraform_version: "1.14.0"
          terraform_wrapper: false

      - name: Terraform fmt check
        run: terraform fmt -check -recursive

  terraform-validate-modules:
    name: terraform validate (modules)
    runs-on: ubuntu-latest
    needs: terraform-fmt

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd
        with:
          terraform_version: "1.14.0"
          terraform_wrapper: false

      - name: Terraform init (no backend)
        working-directory: modules
        run: terraform init -backend=false

      - name: Terraform validate
        working-directory: modules
        run: terraform validate

  terraform-validate-examples:
    name: terraform validate (examples)
    runs-on: ubuntu-latest
    needs: terraform-fmt

    strategy:
      fail-fast: false
      matrix:
        dir:
          - example/both-zone-vpc
          - example/zone-only
          - example/vpc-only

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd
        with:
          terraform_version: "1.14.0"
          terraform_wrapper: false

      - name: Terraform init (no backend)
        working-directory: ${{ matrix.dir }}
        run: terraform init -backend=false

      - name: Terraform validate
        working-directory: ${{ matrix.dir }}
        run: terraform validate

  terraform-plan-examples:
    name: terraform plan (examples)
    runs-on: ubuntu-latest
    needs:
      - terraform-fmt
      - terraform-validate-modules
      - terraform-validate-examples

    # Don't run AWS-authenticated job for fork PRs
    if: |
      (
        github.event_name == 'pull_request'
        && github.event.pull_request.head.repo.full_name == github.repository
        && github.event.pull_request.user.login != 'dependabot[bot]'
      )
      || (
        github.event_name == 'push'
        && github.actor != 'dependabot[bot]'
        && github.actor != 'dependabot'
      )
    strategy:
      fail-fast: false
      matrix:
        dir:
          - example/both-zone-vpc
          - example/zone-only
          - example/vpc-only

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@ff717079ee2060e4bcee96c4779b553acc87447c
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd
        with:
          terraform_version: "1.14.0"
          terraform_wrapper: false

      - name: Terraform init (no backend)
        working-directory: ${{ matrix.dir }}
        run: terraform init -backend=false

      - name: Terraform plan
        working-directory: ${{ matrix.dir }}
        env:
          TF_IN_AUTOMATION: "true"
          TF_VAR_aws_region: ${{ vars.TF_VAR_aws_region }}
          TF_VAR_free_zone_id: ${{ vars.TF_VAR_free_zone_id }}
          TF_VAR_free_log_group_name: ${{ vars.TF_VAR_free_log_group_name }}
          TF_VAR_dns_alert_sns_arn: ${{ vars.TF_VAR_dns_alert_sns_arn }}
          TF_VAR_prefix: ${{ vars.TF_VAR_prefix }}
          TF_VAR_free_vpc_id: ${{ vars.TF_VAR_free_vpc_id }}
        run: terraform plan -lock=false -input=false -refresh=false


  terraform-docs:
    name: terraform-docs (modules)
    runs-on: ubuntu-latest
    needs: terraform-fmt

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Render terraform docs
        uses: terraform-docs/gh-actions@6de6da0cefcc6b4b7a5cbea4d79d97060733093c
        with:
          working-dir: modules
          output-file: README.md
          output-method: inject
          git-push: "false"

      - name: Fail if docs changed
        run: |
          git diff --exit-code


  terraform-validate-modules-latest:
    name: terraform validate (modules) (latest)
    runs-on: ubuntu-latest
    needs: terraform-fmt
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Setup Terraform (latest)
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd
        with:
          terraform_version: latest
          terraform_wrapper: false

      - name: Terraform init (no backend)
        working-directory: modules
        run: terraform init -backend=false

      - name: Terraform validate
        working-directory: modules
        run: terraform validate


  terraform-validate-examples-latest:
    name: terraform validate (examples) (latest)
    runs-on: ubuntu-latest
    needs: terraform-fmt

    strategy:
      fail-fast: false
      matrix:
        dir:
          - example/both-zone-vpc
          - example/zone-only
          - example/vpc-only

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Setup Terraform (latest)
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd
        with:
          terraform_version: latest
          terraform_wrapper: false

      - name: Terraform init (no backend)
        working-directory: ${{ matrix.dir }}
        run: terraform init -backend=false

      - name: Terraform validate
        working-directory: ${{ matrix.dir }}
        run: terraform validate


  terraform-plan-examples-latest:
    name: terraform plan (examples) (latest)
    runs-on: ubuntu-latest
    needs:
      - terraform-fmt
      - terraform-validate-modules-latest
      - terraform-validate-examples-latest

    # Don't run AWS-authenticated job for fork PR
    if: |
      (
        github.event_name == 'pull_request'
        && github.event.pull_request.head.repo.full_name == github.repository
        && github.event.pull_request.user.login != 'dependabot[bot]'
      )
      || (
        github.event_name == 'push'
        && github.actor != 'dependabot[bot]'
        && github.actor != 'dependabot'
      )
    strategy:
      fail-fast: false
      matrix:
        dir:
          - example/both-zone-vpc
          - example/zone-only
          - example/vpc-only

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@ff717079ee2060e4bcee96c4779b553acc87447c
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Setup Terraform (latest)
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd
        with:
          terraform_version: latest
          terraform_wrapper: false

      - name: Terraform init (no backend)
        working-directory: ${{ matrix.dir }}
        run: terraform init -backend=false

      - name: Terraform plan
        working-directory: ${{ matrix.dir }}
        env:
          TF_IN_AUTOMATION: "true"
          TF_VAR_aws_region: ${{ vars.TF_VAR_aws_region }}
          TF_VAR_free_zone_id: ${{ vars.TF_VAR_free_zone_id }}
          TF_VAR_free_log_group_name: ${{ vars.TF_VAR_free_log_group_name }}
          TF_VAR_dns_alert_sns_arn: ${{ vars.TF_VAR_dns_alert_sns_arn }}
          TF_VAR_prefix: ${{ vars.TF_VAR_prefix }}
          TF_VAR_free_vpc_id: ${{ vars.TF_VAR_free_vpc_id }}
        run: terraform plan -lock=false -input=false -refresh=false


