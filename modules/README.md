# Terraform module: Codreum DNS Monitoring (NXDOMAIN)

This module detects DNS misconfiguration by alerting on **NXDOMAIN spikes** using **CloudWatch Logs, Metrics, Dashboards, Alarms, and Contributor Insights**.

It assumes DNS query logs are **already flowing into CloudWatch Logs** (it does not create log groups or ship logs anywhere).

## What it creates

- CloudWatch dashboards for DNS operations visibility
- CloudWatch alarms (including anomaly options, if enabled by variables)
- Custom metrics derived from log patterns
- Contributor Insights “Top-N” rules for triage (e.g., top NXDOMAIN names / sources)

## Prerequisites

1. Terraform >= 1.14
2. AWS provider >= 6.2
3. A CloudWatch Logs group already receiving DNS logs:
   - **Zone mode:** Route 53 hosted zone query logs (CLF-like fields include `hosted_zone_id`, `rcode`, `qname`, etc.)
   - **VPC mode:** JSON resolver query logs (fields include `vpc_id`, `rcode`, `srcaddr`, `query_name` / `qname`, etc.)
4. Region constraints (AWS limitation)
   - **Zone mode (`NX_zone_id`)**: Route 53 *public hosted zone* query logging requires the CloudWatch Logs log group in **`us-east-1` (US East / N. Virginia)**. Deploy this module in **`us-east-1`** for Zone mode.
   - **VPC mode (`NX_vpc_id`)**: Resolver query logging is **regional**. Create the query logging configuration and destination (CloudWatch log group) in the **same region as the VPC**. If you have VPCs in multiple regions, deploy one module per region.
   - If you need both Zone + VPC monitoring across different regions, deploy **two module instances**: one in **`us-east-1`** for Zone mode, plus one per VPC region for Resolver mode.

## Modes (Zone vs VPC)

This module can operate in either (or both) modes:

- **Zone mode**: enabled when `NX_zone_id` is set (non-null)
- **VPC mode**: enabled when `NX_vpc_id` is set (non-null)

## Quickstart

Your canonical Quickstart is in the **repo root** `README.md`.

Minimal example (reference only):

```hcl
module "codreum_dns_NX" {
  source = "github.com/Codreum/terraform-aws-dns-monitoring-nxdomain//modules?ref=v0.1.0"

  prefix             = "acme-dev"
  aws_region         = "us-east-1"
  NX_log_group_name  = "/aws/route53/resolver-query-logs"  # must match your CloudWatch log group name
  dns_alert_sns_arn  = "arn:aws:sns:us-east-1:123456789012:alerts" # change to your SNS ARN

  # Enable one or both:
  NX_vpc_id  = "vpc-0123456789abcdef0" # optional
  NX_zone_id = "Z123EXAMPLE"           # optional
}
```

## Documentation (auto-generated)

The Inputs/Outputs below are **auto-generated by terraform-docs** and kept in sync via **pre-commit** and **CI**.

Manual regen from repo root:

```bash
terraform-docs markdown table --output-file modules/README.md --output-mode inject ./modules
```

> Do not edit the auto-generated section by hand. Update `variable.tf` / `output.tf` instead.

<!-- BEGIN_TF_DOCS -->
## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | >= 1.14.0 |
| <a name="requirement_aws"></a> [aws](#requirement\_aws) | >= 6.2.0 |

## Providers

| Name | Version |
|------|---------|
| <a name="provider_aws"></a> [aws](#provider\_aws) | 6.28.0 |

## Modules

No modules.

## Resources

| Name | Type |
|------|------|
| [aws_cloudwatch_contributor_insight_rule.vpc_topn_nxdomain_qname](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_contributor_insight_rule) | resource |
| [aws_cloudwatch_contributor_insight_rule.vpc_topn_nxdomain_srcip](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_contributor_insight_rule) | resource |
| [aws_cloudwatch_contributor_insight_rule.zone_topn_nxdomain_edge](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_contributor_insight_rule) | resource |
| [aws_cloudwatch_contributor_insight_rule.zone_topn_nxdomain_qname](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_contributor_insight_rule) | resource |
| [aws_cloudwatch_contributor_insight_rule.zone_topn_nxdomain_qtype](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_contributor_insight_rule) | resource |
| [aws_cloudwatch_contributor_insight_rule.zone_topn_nxdomain_rip](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_contributor_insight_rule) | resource |
| [aws_cloudwatch_dashboard.ops_dns_landing](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_dashboard) | resource |
| [aws_cloudwatch_dashboard.vpc_dns_dashboard](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_dashboard) | resource |
| [aws_cloudwatch_dashboard.zone_dns_dashboard](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_dashboard) | resource |
| [aws_cloudwatch_log_metric_filter.vpc_nxdomain_count](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_log_metric_filter) | resource |
| [aws_cloudwatch_log_metric_filter.vpc_total_count](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_log_metric_filter) | resource |
| [aws_cloudwatch_log_metric_filter.zone_nxdomain_count](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_log_metric_filter) | resource |
| [aws_cloudwatch_log_metric_filter.zone_total_count](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_log_metric_filter) | resource |
| [aws_cloudwatch_metric_alarm.vpc_nxdomain_alarm](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_metric_alarm) | resource |
| [aws_cloudwatch_metric_alarm.vpc_nxdomain_anomaly](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_metric_alarm) | resource |
| [aws_cloudwatch_metric_alarm.vpc_nxdomain_rate_alarm](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_metric_alarm) | resource |
| [aws_cloudwatch_metric_alarm.vpc_nxdomain_rate_anomaly](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_metric_alarm) | resource |
| [aws_cloudwatch_metric_alarm.zone_nxdomain_alarm](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_metric_alarm) | resource |
| [aws_cloudwatch_metric_alarm.zone_nxdomain_anomaly](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_metric_alarm) | resource |
| [aws_cloudwatch_metric_alarm.zone_nxdomain_rate_alarm](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_metric_alarm) | resource |
| [aws_cloudwatch_metric_alarm.zone_nxdomain_rate_anomaly](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_metric_alarm) | resource |
| [aws_caller_identity.current](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/caller_identity) | data source |
| [aws_partition.current](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/partition) | data source |
| [aws_route53_zone.NX_zone](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/route53_zone) | data source |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_NX_log_group_name"></a> [NX\_log\_group\_name](#input\_NX\_log\_group\_name) | CloudWatch Logs group for Route 53 Resolver query logs. | `string` | n/a | yes |
| <a name="input_NX_vpc_anomaly_band_width"></a> [NX\_vpc\_anomaly\_band\_width](#input\_NX\_vpc\_anomaly\_band\_width) | Std-dev width for anomaly band on VPC metrics. | `number` | `null` | no |
| <a name="input_NX_vpc_anomaly_eval_periods"></a> [NX\_vpc\_anomaly\_eval\_periods](#input\_NX\_vpc\_anomaly\_eval\_periods) | Evaluation periods for VPC anomaly alarms. | `number` | `null` | no |
| <a name="input_NX_vpc_id"></a> [NX\_vpc\_id](#input\_NX\_vpc\_id) | Optional VPC to scope NXDOMAIN client insights & alarm. | `string` | `null` | no |
| <a name="input_NX_vpc_nxdomain_alarm_period"></a> [NX\_vpc\_nxdomain\_alarm\_period](#input\_NX\_vpc\_nxdomain\_alarm\_period) | n/a | `number` | `null` | no |
| <a name="input_NX_vpc_nxdomain_eval_periods"></a> [NX\_vpc\_nxdomain\_eval\_periods](#input\_NX\_vpc\_nxdomain\_eval\_periods) | n/a | `number` | `null` | no |
| <a name="input_NX_vpc_nxdomain_rate_threshold_pct"></a> [NX\_vpc\_nxdomain\_rate\_threshold\_pct](#input\_NX\_vpc\_nxdomain\_rate\_threshold\_pct) | n/a | `number` | `null` | no |
| <a name="input_NX_vpc_nxdomain_threshold"></a> [NX\_vpc\_nxdomain\_threshold](#input\_NX\_vpc\_nxdomain\_threshold) | n/a | `number` | `null` | no |
| <a name="input_NX_vpc_topn_nxdomain"></a> [NX\_vpc\_topn\_nxdomain](#input\_NX\_vpc\_topn\_nxdomain) | n/a | `number` | `null` | no |
| <a name="input_NX_zone_anomaly_band_width"></a> [NX\_zone\_anomaly\_band\_width](#input\_NX\_zone\_anomaly\_band\_width) | Std-dev width for anomaly band on Zone metrics (e.g., 2.0 ≈ ~95%). | `number` | `null` | no |
| <a name="input_NX_zone_anomaly_eval_periods"></a> [NX\_zone\_anomaly\_eval\_periods](#input\_NX\_zone\_anomaly\_eval\_periods) | Evaluation periods for Zone anomaly alarms. | `number` | `null` | no |
| <a name="input_NX_zone_id"></a> [NX\_zone\_id](#input\_NX\_zone\_id) | Optional hosted zone (Zxxxxxxxx) to scope 'top NXDOMAIN names'. | `string` | `null` | no |
| <a name="input_NX_zone_nxdomain_alarm_period"></a> [NX\_zone\_nxdomain\_alarm\_period](#input\_NX\_zone\_nxdomain\_alarm\_period) | n/a | `number` | `null` | no |
| <a name="input_NX_zone_nxdomain_eval_periods"></a> [NX\_zone\_nxdomain\_eval\_periods](#input\_NX\_zone\_nxdomain\_eval\_periods) | n/a | `number` | `null` | no |
| <a name="input_NX_zone_nxdomain_rate_threshold_pct"></a> [NX\_zone\_nxdomain\_rate\_threshold\_pct](#input\_NX\_zone\_nxdomain\_rate\_threshold\_pct) | n/a | `number` | `null` | no |
| <a name="input_NX_zone_nxdomain_threshold"></a> [NX\_zone\_nxdomain\_threshold](#input\_NX\_zone\_nxdomain\_threshold) | n/a | `number` | `null` | no |
| <a name="input_NX_zone_topn_nxdomain"></a> [NX\_zone\_topn\_nxdomain](#input\_NX\_zone\_topn\_nxdomain) | n/a | `number` | `null` | no |
| <a name="input_aws_region"></a> [aws\_region](#input\_aws\_region) | n/a | `string` | n/a | yes |
| <a name="input_dns_alert_sns_arn"></a> [dns\_alert\_sns\_arn](#input\_dns\_alert\_sns\_arn) | SNS ARN for alarms. | `string` | n/a | yes |
| <a name="input_prefix"></a> [prefix](#input\_prefix) | n/a | `string` | n/a | yes |
| <a name="input_tags"></a> [tags](#input\_tags) | n/a | `map(string)` | n/a | yes |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_alarms"></a> [alarms](#output\_alarms) | Alarm names and ARNs for integrating with other systems. |
| <a name="output_contributor_insights_rules"></a> [contributor\_insights\_rules](#output\_contributor\_insights\_rules) | Contributor Insights rule names (Top-N) created by this module. |
| <a name="output_dashboards"></a> [dashboards](#output\_dashboards) | CloudWatch dashboard names and console URLs. |
| <a name="output_enabled"></a> [enabled](#output\_enabled) | Which modes are enabled in this deployment. |
| <a name="output_metrics"></a> [metrics](#output\_metrics) | Custom metric namespace and metric names created by this module. |
<!-- END_TF_DOCS -->
