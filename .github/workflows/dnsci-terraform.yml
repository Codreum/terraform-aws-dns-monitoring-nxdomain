name: CI - Terraform

on:
  push:
    branches: ["**"]
  pull_request:

permissions:
  contents: read

jobs:
  terraform-fmt:
    name: terraform fmt (repo)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.14.0"
          terraform_wrapper: false

      - name: Terraform fmt check
        run: terraform fmt -check -recursive

  terraform-validate-modules:
    name: terraform validate (modules)
    runs-on: ubuntu-latest
    needs: terraform-fmt

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.14.0"
          terraform_wrapper: false

      - name: Terraform init (no backend)
        working-directory: modules
        run: terraform init -backend=false

      - name: Terraform validate
        working-directory: modules
        run: terraform validate

  terraform-validate-examples:
    name: terraform validate (examples)
    runs-on: ubuntu-latest
    needs: terraform-fmt

    strategy:
      fail-fast: false
      matrix:
        dir:
          - example/both-zone-vpc
          - example/zone-only
          - example/vpc-only

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.14.0"
          terraform_wrapper: false

      - name: Terraform init (no backend)
        working-directory: ${{ matrix.dir }}
        run: terraform init -backend=false

      - name: Terraform validate
        working-directory: ${{ matrix.dir }}
        run: terraform validate

  terraform-docs:
    name: terraform-docs (modules)
    runs-on: ubuntu-latest
    needs: terraform-fmt

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Render terraform docs
        uses: terraform-docs/gh-actions@v1.4.1
        with:
          working-dir: modules
          output-file: README.md
          output-method: inject
          git-push: "false"

      - name: Fail if docs changed
        run: |
          git diff --exit-code
